// ==UserScript==
// @name         Purple Adblocker
// @source       https://github.com/arthurbolsoni/Purple-adblock
// @version      2.6.2
// @description  Per aspera ad astra
// @author       ArthurBolzoni
// @downloadURL  https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/platform/tampermonkey/dist/purpleadblocker.user.js
// @updateURL    https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/platform/tampermonkey/dist/purpleadblocker.user.js
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(()=>{"use strict";var t={114:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}u((s=s.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const n=r(i(597));!function(){let t;window.Worker=class extends Worker{constructor(e,i){console.log("new worker intance "+e),""==e.toString()&&super(e,i),console.log("[Purple]: init "+e.toString());const s=new XMLHttpRequest;s.open("GET",e.toString(),!1),s.send();const r=s.responseText,a=`${n.default}\n      ${r}`;console.log(e.toString(),r),super(URL.createObjectURL(new Blob([a],{type:"text/javascript"}))),t=this,t.declareEventWorker(),t.declareEventWindow(),t.integrity()}integrity(){return s(this,void 0,void 0,(function*(){i.g.request=fetch,i.g.fetch=(e,r)=>s(this,void 0,void 0,(function*(){const s=yield i.g.request(e,r),n=yield s.text();return"https://gql.twitch.tv/integrity"==e&&t.postMessage({funcName:"setIntegrity",value:n}),new Response(n,s)}))}))}declareEventWorker(){this.addEventListener("message",(e=>{var i,s,r,n,a;switch(null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.type){case"getSettings":window.postMessage({type:"getSettings",value:null});break;case"PlayerQualityChanged":t.postMessage({funcName:"setQuality",value:e.data.arg.name});break;case"pause":t.postMessage({funcName:"pause",args:void 0,id:1});break;case"play":t.postMessage({funcName:"play",args:void 0,id:1})}switch(null===(r=null===(s=null==e?void 0:e.data)||void 0===s?void 0:s.arg)||void 0===r?void 0:r.key){case"quality":if(!e.data.arg.value.name)break;console.log("Changed quality by player: "+e.data.arg.value.name),t.postMessage({funcName:"setQuality",value:e.data.arg.value.name});break;case"state":t.postMessage({funcName:e.data.arg.value})}null===(a=null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.arg)||void 0===a||a.name}))}declareEventWindow(){window.addEventListener("message",(e=>{"setSettings"===e.data.type&&t.postMessage({funcName:"setSettings",value:e.data.value})}))}}}()},597:t=>{t.exports='/*! For license information please see app.worker.js.LICENSE.txt */\n(()=>{var t={799:function(t,e,i){"use strict";var s=this&&this.__decorate||function(t,e,i,s){var r,n=arguments.length,a=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(a=(n<3?r(a):n>3?r(e,i,a):r(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a},r=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}u((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.AppController=void 0;const n=i(289),a=i(35),o=i(938);let u=class{constructor(t){this.appService=t,this.getSettings=()=>i.g.postMessage({type:"getSettings"}),this.getSettings()}setIntegrity(t){return r(this,void 0,void 0,(function*(){this.appService.setIntegrityToken(JSON.parse(t.value).token)}))}onChannel(t,e){return r(this,void 0,void 0,(function*(){const s=yield i.g.request(t,e);if(!s.ok)return console.log("Error on channel load"),s;const r=yield s.text(),n=/hls\\/(.*).m3u8/gm.exec(t)||[];return yield this.appService.setChannel(n[1]),new Response(r)}))}onFetch(t,e){return r(this,void 0,void 0,(function*(){const i=yield(yield request(t,e)).text(),s=yield this.appService.onFetch(i);return new Response(s)}))}onChannelPicture(t,e){return r(this,void 0,void 0,(function*(){const s=yield i.g.request(t,e);if(!s.ok)return console.log("Error on channel load"),s;const r=yield s.text();return yield this.appService.currentStream().setStreamAccess(r,o.StreamType.PICTURE),console.log("picture-by-picture",r),new Response}))}setSettings(t){return r(this,void 0,void 0,(function*(){this.appService.setSettings(t)}))}setQuality(t){return r(this,void 0,void 0,(function*(){this.appService.quality=t.value}))}};s([(0,a.Message)("setIntegrity")],u.prototype,"setIntegrity",null),s([(0,a.Fetch)("usher.ttvnw.net/api/channel/hls/","picture-by-picture")],u.prototype,"onChannel",null),s([(0,a.Fetch)("hls.ttvnw.net/v1/playlist/")],u.prototype,"onFetch",null),s([(0,a.Fetch)("picture-by-picture")],u.prototype,"onChannelPicture",null),s([(0,a.Message)("setSettings")],u.prototype,"setSettings",null),s([(0,a.Message)("setQuality")],u.prototype,"setQuality",null),u=s([(0,n.Controller)()],u),e.AppController=u},37:function(t,e,i){"use strict";var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}u((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=i(799),n=i(651);function a(){i.g.logPrint=t=>console.log("[Purple]: ",t),i.g.appController=new r.AppController(new n.Player),i.g.logPrint("Script running")}e.default=a,i.g.request=i.g.fetch,i.g.fetch=(t,e)=>s(void 0,void 0,void 0,(function*(){if("string"==typeof t)for(var s=0,r=routerList.length;s<r;s++)if(t.includes(routerList[s].match)&&!t.includes(routerList[s].ignore))return i.g.appController[routerList[s].propertyKey](t,e);return i.g.request.apply(this,[t,e])})),a()},289:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Controller=void 0,e.Controller=()=>t=>{}},35:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Message=e.Fetch=void 0,e.Fetch=(t,e=null)=>(s,r)=>{i.g.routerList||(i.g.routerList=[]),i.g.routerList.push({propertyKey:r,match:t,ignore:e})},e.Message=t=>(e,s)=>{i.g.addEventListener("message",(e=>{var r;(null===(r=null==e?void 0:e.data)||void 0===r?void 0:r.funcName)==t&&i.g.appController[s](e.data)}))}},651:function(t,e,i){"use strict";var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}u((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.Player=void 0;const r=i(770),n=i(938),a=i(682);e.Player=class{constructor(){this.integrityToken="",this.streamList=[],this.actualChannel="",this.playingAds=!1,this.quality="",this.getQuality=()=>i.g.postMessage({type:"getQuality"}),this.getSettings=()=>i.g.postMessage({type:"getSettings"}),this.pause=()=>i.g.postMessage({type:"pause"}),this.play=()=>i.g.postMessage({type:"play"}),this.setSettings=t=>{this.setting=t,logPrint("Settings loaded")},this.setIntegrityToken=t=>this.integrityToken=t,this.pauseAndPlay=()=>s(this,void 0,void 0,(function*(){this.pause(),yield new Promise((t=>setTimeout(t,500))),this.play()})),this.onStartAds=()=>{console.log("ads started"),this.pauseAndPlay(),this.pauseAndPlay()},this.onEndAds=()=>{console.log("ads ended"),this.pauseAndPlay(),this.pauseAndPlay()},this.isAds=(t,e=!1)=>{const i=this.hasAds(t);return e?(0==this.playingAds&&this.playingAds!=i&&this.onStartAds(),1==this.playingAds&&this.playingAds!=i&&this.onEndAds(),this.playingAds=i,this.playingAds):i},this.hasAds=t=>(null==t?void 0:t.toString().includes("stitched"))||(null==t?void 0:t.toString().includes("Amazon"))||(null==t?void 0:t.toString().includes("DCM,")),this.currentStream=(t=this.actualChannel)=>{var e;return null===(e=this.streamList)||void 0===e?void 0:e.find((e=>e.channelName===t))}}isWhitelist(){var t,e;return(null===(e=null===(t=this.setting)||void 0===t?void 0:t.whitelist)||void 0===e?void 0:e.includes(this.actualChannel))||!1}onFetch(t){var e,i;return s(this,void 0,void 0,(function*(){if(this.isWhitelist())return t;if(!this.isAds(t,!0))return this.mergeM3u8Contents([t]);let s=[];const r=yield this.fetchm3u8ByStreamType(n.StreamType.FRONTPAGE);r.data||this.currentStream().createStreamAccess(n.StreamType.FRONTPAGE,this.integrityToken),r.data&&s.push(...r.dump);const a=yield this.fetchm3u8ByStreamType(n.StreamType.PICTURE);return a.data||this.currentStream().createStreamAccess(n.StreamType.PICTURE,this.integrityToken),a.data?Promise.resolve(null!==(i=null===(e=a.dump)||void 0===e?void 0:e[0])&&void 0!==i?i:""):0!=s.length?this.mergeM3u8Contents([t,...s]):t}))}generateM3u8(t){let e="#EXTM3U\\n";return t.targetDuration&&(e+=`#EXT-X-TARGETDURATION:${t.targetDuration}\\n`),t.mediaSequence&&(e+=`#EXT-X-MEDIA-SEQUENCE:${t.mediaSequence}\\n`),t.segments&&t.segments.forEach((t=>{t.duration&&(e+=`#EXTINF:${t.duration}`,e+="\\n"),e+=`${t.uri}\\n`})),e}mergeM3u8Contents(t){const e=t.map((t=>{const e=new a.Parser;e.push(t),e.end();const i=e.manifest;return i.segments&&i.segments.forEach((e=>{const i=new RegExp(`#EXTINF:([0-9.]*)?,?(.*)(?:\\n|\\r\\n)${e.uri}`),s=t.match(i);s&&(e.title=s[2]?s[2].trim():"")})),i})),i=e[0],s=e.slice(1);if(i.segments){console.log("Segmentos encontrados no manifesto principal:",i.segments.length),console.log("Manifestos de suporte encontrados:",s.length);let t=0,e=0;for(let r=0;r<i.segments.length;r++){const n=i.segments[r];let a=!1;this.hasAds(n.title)&&(s.forEach((t=>{var e;const s=null===(e=null==t?void 0:t.segments)||void 0===e?void 0:e.find((t=>{if(this.hasAds(t.title))return!1;const e=new Date(n.dateTimeString),i=new Date(t.dateTimeString);return e.setMilliseconds(0),i.setMilliseconds(0),e.getTime()===i.getTime()}));s&&(i.segments[r]=s,a=!0)})),a||(i.segments.splice(r,1),r--,t++),a&&e++)}console.log("Segmento com ads removidos:",t),console.log("Segmento com ads substituÃ­dos:",e)}return this.generateM3u8(i)}fetchm3u8ByStreamType(t){return s(this,void 0,void 0,(function*(){logPrint("Stream Type: "+t);let e=[],s=this.currentStream().getStreamByStreamType(t);for(const r of s){const s=r.findByQuality(this.quality)||r.bestQuality(),n=yield(yield i.g.request(null==s?void 0:s.url)).text();if(e.push(n),!this.isAds(n))return{data:n,dump:e};logPrint("Stream Type: "+t+" - Ads found"),this.currentStream().removeServer(r)}return{data:null,dump:e}}))}setChannel(t){logPrint("Loading channel",t),this.actualChannel=t;let e=this.streamList.find((e=>e.channelName===t));e||(e=new r.Stream(t),this.streamList.push(e))}}},938:(t,e)=>{"use strict";var i;Object.defineProperty(e,"__esModule",{value:!0}),e.StreamType=void 0,(i=e.StreamType||(e.StreamType={})).PICTURE="picture-by-picture",i.THUNDERDOME="thunderdome",i.EMBED="embed",i.FRONTPAGE="frontpage",i.SITE="site",i.EXTERNAL="external",i.DNS="dns"},503:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Server=e.StreamUrl=void 0,e.StreamUrl=class{constructor(){this.url="",this.quality=""}},e.Server=class{constructor(t){this.bestQuality=()=>this.urlList[0],this.findByQuality=t=>this.urlList.find((e=>e.quality==t)),Object.assign(this,t)}}},770:function(t,e,i){"use strict";var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}u((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.Stream=void 0;const r=i(758),n=i(503);e.Stream=class{constructor(t){this.serverList=[],this.channelName=t,this.twitchService=new r.TwitchService("")}removeServer(t){const e=this.serverList.indexOf(t);e>-1&&this.serverList.splice(e,1)}setStreamAccess(t,e="local",i=!0){const s=[];let r;const a=/NAME="((?:\\S+\\s+\\S+|\\S+))",AUTO(?:^|\\S+\\s+)(?:^|\\S+\\s+)(https:\\/\\/video(\\S+).m3u8)/g;for(;null!==(r=a.exec(t));)s.push({quality:r[1],url:r[2]});const o=new n.Server({type:e,urlList:s,sig:i});this.serverList.push(o)}createStreamAccess(t,e){return s(this,void 0,void 0,(function*(){try{const i=yield this.twitchService.playbackAccessToken(this.channelName,t,e);console.log("New Connection: ",t,i.token.includes(\'"hide_ads":true\'));const s=yield this.twitchService.getM3U8(this.channelName,i);this.setStreamAccess(s,t)}catch(t){logPrint(t)}}))}getStreamByStreamType(t){return this.serverList.filter((e=>e.type==t))||[]}}},758:function(t,e,i){"use strict";var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}u((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.TwitchService=void 0,e.TwitchService=class{constructor(t){this.integrityToken=t}playbackAccessToken(t,e,r){return s(this,void 0,void 0,(function*(){const s={operationName:"PlaybackAccessToken",variables:{isLive:!0,login:t,isVod:!1,vodID:"",playerType:e},extensions:{persistedQuery:{version:1,sha256Hash:"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}},n=yield i.g.request("https://gql.twitch.tv/gql#origin=twilight",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko","Client-Integrity":r},body:JSON.stringify(s)}),a=yield n.json();return{token:a.data.streamPlaybackAccessToken.value,signature:a.data.streamPlaybackAccessToken.signature}}))}playbackAccessToken_Template(t,e){return s(this,void 0,void 0,(function*(){const s={operationName:"PlaybackAccessToken_Template",query:\'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) { streamPlaybackAccessToken(channelName: $login, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) { value signature __typename } videoPlaybackAccessToken(id: $vodID, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) { value signature __typename }}\',variables:{isLive:!0,isVod:!1,vodID:"",login:t,playerType:e}},r=yield i.g.request("https://gql.twitch.tv/gql",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:JSON.stringify(s)}),n=yield r.json();return{token:n.data.streamPlaybackAccessToken.value,signature:n.data.streamPlaybackAccessToken.signature}}))}getM3U8(t,e){return s(this,void 0,void 0,(function*(){const s="allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+e.signature+"&supported_codecs=avc1&token="+e.token;return(yield i.g.request("https://usher.ttvnw.net/api/channel/hls/"+t+".m3u8?"+s)).text()}))}}},908:(t,e,i)=>{var s;s="undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:{},t.exports=s},682:(t,e,i)=>{"use strict";i.r(e),i.d(e,{LineStream:()=>u,ParseStream:()=>d,Parser:()=>f});var s=function(){function t(){this.listeners={}}var e=t.prototype;return e.on=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},e.off=function(t,e){if(!this.listeners[t])return!1;var i=this.listeners[t].indexOf(e);return this.listeners[t]=this.listeners[t].slice(0),this.listeners[t].splice(i,1),i>-1},e.trigger=function(t){var e=this.listeners[t];if(e)if(2===arguments.length)for(var i=e.length,s=0;s<i;++s)e[s].call(this,arguments[1]);else for(var r=Array.prototype.slice.call(arguments,1),n=e.length,a=0;a<n;++a)e[a].apply(this,r)},e.dispose=function(){this.listeners={}},e.pipe=function(t){this.on("data",(function(e){t.push(e)}))},t}();function r(){return r=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])}return t},r.apply(this,arguments)}var n=i(908),a=i.n(n);function o(t){for(var e,i=(e=t,a().atob?a().atob(e):Buffer.from(e,"base64").toString("binary")),s=new Uint8Array(i.length),r=0;r<i.length;r++)s[r]=i.charCodeAt(r);return s}class u extends s{constructor(){super(),this.buffer=""}push(t){let e;for(this.buffer+=t,e=this.buffer.indexOf("\\n");e>-1;e=this.buffer.indexOf("\\n"))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)}}const c=String.fromCharCode(9),l=function(t){const e=/([0-9.]*)?@?([0-9.]*)?/.exec(t||""),i={};return e[1]&&(i.length=parseInt(e[1],10)),e[2]&&(i.offset=parseInt(e[2],10)),i},g=function(t){const e={};if(!t)return e;const i=t.split(new RegExp(\'(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))\'));let s,r=i.length;for(;r--;)""!==i[r]&&(s=/([^=]*)=(.*)/.exec(i[r]).slice(1),s[0]=s[0].replace(/^\\s+|\\s+$/g,""),s[1]=s[1].replace(/^\\s+|\\s+$/g,""),s[1]=s[1].replace(/^[\'"](.*)[\'"]$/g,"$1"),e[s[0]]=s[1]);return e};class d extends s{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(t){let e,i;0!==(t=t.trim()).length&&("#"===t[0]?this.tagMappers.reduce(((e,i)=>{const s=i(t);return s===t?e:e.concat([s])}),[t]).forEach((t=>{for(let e=0;e<this.customParsers.length;e++)if(this.customParsers[e].call(this,t))return;if(0===t.indexOf("#EXT"))if(t=t.replace("\\r",""),e=/^#EXTM3U/.exec(t),e)this.trigger("data",{type:"tag",tagType:"m3u"});else{if(e=/^#EXTINF:([0-9\\.]*)?,?(.*)?$/.exec(t),e)return i={type:"tag",tagType:"inf"},e[1]&&(i.duration=parseFloat(e[1])),e[2]&&(i.title=e[2]),void this.trigger("data",i);if(e=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(t),e)return i={type:"tag",tagType:"targetduration"},e[1]&&(i.duration=parseInt(e[1],10)),void this.trigger("data",i);if(e=/^#EXT-X-VERSION:([0-9.]*)?/.exec(t),e)return i={type:"tag",tagType:"version"},e[1]&&(i.version=parseInt(e[1],10)),void this.trigger("data",i);if(e=/^#EXT-X-MEDIA-SEQUENCE:(\\-?[0-9.]*)?/.exec(t),e)return i={type:"tag",tagType:"media-sequence"},e[1]&&(i.number=parseInt(e[1],10)),void this.trigger("data",i);if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\\-?[0-9.]*)?/.exec(t),e)return i={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(i.number=parseInt(e[1],10)),void this.trigger("data",i);if(e=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(t),e)return i={type:"tag",tagType:"playlist-type"},e[1]&&(i.playlistType=e[1]),void this.trigger("data",i);if(e=/^#EXT-X-BYTERANGE:(.*)?$/.exec(t),e)return i=r(l(e[1]),{type:"tag",tagType:"byterange"}),void this.trigger("data",i);if(e=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(t),e)return i={type:"tag",tagType:"allow-cache"},e[1]&&(i.allowed=!/NO/.test(e[1])),void this.trigger("data",i);if(e=/^#EXT-X-MAP:(.*)$/.exec(t),e){if(i={type:"tag",tagType:"map"},e[1]){const t=g(e[1]);t.URI&&(i.uri=t.URI),t.BYTERANGE&&(i.byterange=l(t.BYTERANGE))}this.trigger("data",i)}else if(e=/^#EXT-X-STREAM-INF:(.*)$/.exec(t),e){if(i={type:"tag",tagType:"stream-inf"},e[1]){if(i.attributes=g(e[1]),i.attributes.RESOLUTION){const t=i.attributes.RESOLUTION.split("x"),e={};t[0]&&(e.width=parseInt(t[0],10)),t[1]&&(e.height=parseInt(t[1],10)),i.attributes.RESOLUTION=e}i.attributes.BANDWIDTH&&(i.attributes.BANDWIDTH=parseInt(i.attributes.BANDWIDTH,10)),i.attributes["FRAME-RATE"]&&(i.attributes["FRAME-RATE"]=parseFloat(i.attributes["FRAME-RATE"])),i.attributes["PROGRAM-ID"]&&(i.attributes["PROGRAM-ID"]=parseInt(i.attributes["PROGRAM-ID"],10))}this.trigger("data",i)}else{if(e=/^#EXT-X-MEDIA:(.*)$/.exec(t),e)return i={type:"tag",tagType:"media"},e[1]&&(i.attributes=g(e[1])),void this.trigger("data",i);if(e=/^#EXT-X-ENDLIST/.exec(t),e)this.trigger("data",{type:"tag",tagType:"endlist"});else if(e=/^#EXT-X-DISCONTINUITY/.exec(t),e)this.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(e=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(t),e)return i={type:"tag",tagType:"program-date-time"},e[1]&&(i.dateTimeString=e[1],i.dateTimeObject=new Date(e[1])),void this.trigger("data",i);if(e=/^#EXT-X-KEY:(.*)$/.exec(t),e)return i={type:"tag",tagType:"key"},e[1]&&(i.attributes=g(e[1]),i.attributes.IV&&("0x"===i.attributes.IV.substring(0,2).toLowerCase()&&(i.attributes.IV=i.attributes.IV.substring(2)),i.attributes.IV=i.attributes.IV.match(/.{8}/g),i.attributes.IV[0]=parseInt(i.attributes.IV[0],16),i.attributes.IV[1]=parseInt(i.attributes.IV[1],16),i.attributes.IV[2]=parseInt(i.attributes.IV[2],16),i.attributes.IV[3]=parseInt(i.attributes.IV[3],16),i.attributes.IV=new Uint32Array(i.attributes.IV))),void this.trigger("data",i);if(e=/^#EXT-X-START:(.*)$/.exec(t),e)return i={type:"tag",tagType:"start"},e[1]&&(i.attributes=g(e[1]),i.attributes["TIME-OFFSET"]=parseFloat(i.attributes["TIME-OFFSET"]),i.attributes.PRECISE=/YES/.test(i.attributes.PRECISE)),void this.trigger("data",i);if(e=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(t),e)return i={type:"tag",tagType:"cue-out-cont"},e[1]?i.data=e[1]:i.data="",void this.trigger("data",i);if(e=/^#EXT-X-CUE-OUT:(.*)?$/.exec(t),e)return i={type:"tag",tagType:"cue-out"},e[1]?i.data=e[1]:i.data="",void this.trigger("data",i);if(e=/^#EXT-X-CUE-IN:(.*)?$/.exec(t),e)return i={type:"tag",tagType:"cue-in"},e[1]?i.data=e[1]:i.data="",void this.trigger("data",i);if(e=/^#EXT-X-SKIP:(.*)$/.exec(t),e&&e[1])return i={type:"tag",tagType:"skip"},i.attributes=g(e[1]),i.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(i.attributes["SKIPPED-SEGMENTS"]=parseInt(i.attributes["SKIPPED-SEGMENTS"],10)),i.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(i.attributes["RECENTLY-REMOVED-DATERANGES"]=i.attributes["RECENTLY-REMOVED-DATERANGES"].split(c)),void this.trigger("data",i);if(e=/^#EXT-X-PART:(.*)$/.exec(t),e&&e[1])return i={type:"tag",tagType:"part"},i.attributes=g(e[1]),["DURATION"].forEach((function(t){i.attributes.hasOwnProperty(t)&&(i.attributes[t]=parseFloat(i.attributes[t]))})),["INDEPENDENT","GAP"].forEach((function(t){i.attributes.hasOwnProperty(t)&&(i.attributes[t]=/YES/.test(i.attributes[t]))})),i.attributes.hasOwnProperty("BYTERANGE")&&(i.attributes.byterange=l(i.attributes.BYTERANGE)),void this.trigger("data",i);if(e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(t),e&&e[1])return i={type:"tag",tagType:"server-control"},i.attributes=g(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach((function(t){i.attributes.hasOwnProperty(t)&&(i.attributes[t]=parseFloat(i.attributes[t]))})),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach((function(t){i.attributes.hasOwnProperty(t)&&(i.attributes[t]=/YES/.test(i.attributes[t]))})),void this.trigger("data",i);if(e=/^#EXT-X-PART-INF:(.*)$/.exec(t),e&&e[1])return i={type:"tag",tagType:"part-inf"},i.attributes=g(e[1]),["PART-TARGET"].forEach((function(t){i.attributes.hasOwnProperty(t)&&(i.attributes[t]=parseFloat(i.attributes[t]))})),void this.trigger("data",i);if(e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(t),e&&e[1])return i={type:"tag",tagType:"preload-hint"},i.attributes=g(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach((function(t){if(i.attributes.hasOwnProperty(t)){i.attributes[t]=parseInt(i.attributes[t],10);const e="BYTERANGE-LENGTH"===t?"length":"offset";i.attributes.byterange=i.attributes.byterange||{},i.attributes.byterange[e]=i.attributes[t],delete i.attributes[t]}})),void this.trigger("data",i);if(e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(t),e&&e[1])return i={type:"tag",tagType:"rendition-report"},i.attributes=g(e[1]),["LAST-MSN","LAST-PART"].forEach((function(t){i.attributes.hasOwnProperty(t)&&(i.attributes[t]=parseInt(i.attributes[t],10))})),void this.trigger("data",i);this.trigger("data",{type:"tag",data:t.slice(4)})}}}else this.trigger("data",{type:"comment",text:t.slice(1)})})):this.trigger("data",{type:"uri",uri:t}))}addParser({expression:t,customType:e,dataParser:i,segment:s}){"function"!=typeof i&&(i=t=>t),this.customParsers.push((r=>{if(t.exec(r))return this.trigger("data",{type:"custom",data:i(r),customType:e,segment:s}),!0}))}addTagMapper({expression:t,map:e}){this.tagMappers.push((i=>t.test(i)?e(i):i))}}const h=function(t){const e={};return Object.keys(t).forEach((function(i){var s;e[(s=i,s.toLowerCase().replace(/-(\\w)/g,(t=>t[1].toUpperCase())))]=t[i]})),e},p=function(t){const{serverControl:e,targetDuration:i,partTargetDuration:s}=t;if(!e)return;const r="#EXT-X-SERVER-CONTROL",n="holdBack",a="partHoldBack",o=i&&3*i,u=s&&2*s;i&&!e.hasOwnProperty(n)&&(e[n]=o,this.trigger("info",{message:`${r} defaulting HOLD-BACK to targetDuration * 3 (${o}).`})),o&&e[n]<o&&(this.trigger("warn",{message:`${r} clamping HOLD-BACK (${e[n]}) to targetDuration * 3 (${o})`}),e[n]=o),s&&!e.hasOwnProperty(a)&&(e[a]=3*s,this.trigger("info",{message:`${r} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${e[a]}).`})),s&&e[a]<u&&(this.trigger("warn",{message:`${r} clamping PART-HOLD-BACK (${e[a]}) to partTargetDuration * 2 (${u}).`}),e[a]=u)};class f extends s{constructor(){super(),this.lineStream=new u,this.parseStream=new d,this.lineStream.pipe(this.parseStream);const t=this,e=[];let i,s,n={},a=!1;const c=function(){},l={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}};let g=0;this.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};let f=0,y=0;this.on("end",(()=>{n.uri||!n.parts&&!n.preloadHints||(!n.map&&i&&(n.map=i),!n.key&&s&&(n.key=s),n.timeline||"number"!=typeof g||(n.timeline=g),this.manifest.preloadSegment=n)})),this.parseStream.on("data",(function(u){let d,m;({tag(){({version(){u.version&&(this.manifest.version=u.version)},"allow-cache"(){this.manifest.allowCache=u.allowed,"allowed"in u||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){const t={};"length"in u&&(n.byterange=t,t.length=u.length,"offset"in u||(u.offset=f)),"offset"in u&&(n.byterange=t,t.offset=u.offset),f=t.offset+t.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),u.duration>0&&(n.duration=u.duration),0===u.duration&&(n.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=e},key(){if(u.attributes)if("NONE"!==u.attributes.METHOD)if(u.attributes.URI){if("com.apple.streamingkeydelivery"===u.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:u.attributes});if("com.microsoft.playready"===u.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.microsoft.playready"]={uri:u.attributes.URI});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===u.attributes.KEYFORMAT)return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(u.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===u.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==u.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):u.attributes.KEYID&&"0x"===u.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:u.attributes.KEYFORMAT,keyId:u.attributes.KEYID.substring(2)},pssh:o(u.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}));u.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),s={method:u.attributes.METHOD||"AES-128",uri:u.attributes.URI},void 0!==u.attributes.IV&&(s.iv=u.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else s=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence"(){isFinite(u.number)?this.manifest.mediaSequence=u.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+u.number})},"discontinuity-sequence"(){isFinite(u.number)?(this.manifest.discontinuitySequence=u.number,g=u.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+u.number})},"playlist-type"(){/VOD|EVENT/.test(u.playlistType)?this.manifest.playlistType=u.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+u.playlist})},map(){i={},u.uri&&(i.uri=u.uri),u.byterange&&(i.byterange=u.byterange),s&&(i.key=s)},"stream-inf"(){this.manifest.playlists=e,this.manifest.mediaGroups=this.manifest.mediaGroups||l,u.attributes?(n.attributes||(n.attributes={}),r(n.attributes,u.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||l,!(u.attributes&&u.attributes.TYPE&&u.attributes["GROUP-ID"]&&u.attributes.NAME))return void this.trigger("warn",{message:"ignoring incomplete or missing media group"});const t=this.manifest.mediaGroups[u.attributes.TYPE];t[u.attributes["GROUP-ID"]]=t[u.attributes["GROUP-ID"]]||{},d=t[u.attributes["GROUP-ID"]],m={default:/yes/i.test(u.attributes.DEFAULT)},m.default?m.autoselect=!0:m.autoselect=/yes/i.test(u.attributes.AUTOSELECT),u.attributes.LANGUAGE&&(m.language=u.attributes.LANGUAGE),u.attributes.URI&&(m.uri=u.attributes.URI),u.attributes["INSTREAM-ID"]&&(m.instreamId=u.attributes["INSTREAM-ID"]),u.attributes.CHARACTERISTICS&&(m.characteristics=u.attributes.CHARACTERISTICS),u.attributes.FORCED&&(m.forced=/yes/i.test(u.attributes.FORCED)),d[u.attributes.NAME]=m},discontinuity(){g+=1,n.discontinuity=!0,this.manifest.discontinuityStarts.push(e.length)},"program-date-time"(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=u.dateTimeString,this.manifest.dateTimeObject=u.dateTimeObject),n.dateTimeString=u.dateTimeString,n.dateTimeObject=u.dateTimeObject},targetduration(){!isFinite(u.duration)||u.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+u.duration}):(this.manifest.targetDuration=u.duration,p.call(this,this.manifest))},start(){u.attributes&&!isNaN(u.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:u.attributes["TIME-OFFSET"],precise:u.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out"(){n.cueOut=u.data},"cue-out-cont"(){n.cueOutCont=u.data},"cue-in"(){n.cueIn=u.data},skip(){this.manifest.skip=h(u.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",u.attributes,["SKIPPED-SEGMENTS"])},part(){a=!0;const t=this.manifest.segments.length,e=h(u.attributes);n.parts=n.parts||[],n.parts.push(e),e.byterange&&(e.byterange.hasOwnProperty("offset")||(e.byterange.offset=y),y=e.byterange.offset+e.byterange.length);const i=n.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${i} for segment #${t}`,u.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach(((t,e)=>{t.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${e} lacks required attribute(s): LAST-PART`})}))},"server-control"(){const t=this.manifest.serverControl=h(u.attributes);t.hasOwnProperty("canBlockReload")||(t.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),p.call(this,this.manifest),t.canSkipDateranges&&!t.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const t=this.manifest.segments.length,e=h(u.attributes),i=e.type&&"PART"===e.type;n.preloadHints=n.preloadHints||[],n.preloadHints.push(e),e.byterange&&(e.byterange.hasOwnProperty("offset")||(e.byterange.offset=i?y:0,i&&(y=e.byterange.offset+e.byterange.length)));const s=n.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${s} for segment #${t}`,u.attributes,["TYPE","URI"]),e.type)for(let i=0;i<n.preloadHints.length-1;i++){const r=n.preloadHints[i];r.type&&r.type===e.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${s} for segment #${t} has the same TYPE ${e.type} as preload hint #${i}`})}},"rendition-report"(){const t=h(u.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(t);const e=this.manifest.renditionReports.length-1,i=["LAST-MSN","URI"];a&&i.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${e}`,u.attributes,i)},"part-inf"(){this.manifest.partInf=h(u.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",u.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),p.call(this,this.manifest)}}[u.tagType]||c).call(t)},uri(){n.uri=u.uri,e.push(n),this.manifest.targetDuration&&!("duration"in n)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),n.duration=this.manifest.targetDuration),s&&(n.key=s),n.timeline=g,i&&(n.map=i),y=0,n={}},comment(){},custom(){u.segment?(n.custom=n.custom||{},n.custom[u.customType]=u.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[u.customType]=u.data)}})[u.type].call(t)}))}warnOnMissingAttributes_(t,e,i){const s=[];i.forEach((function(t){e.hasOwnProperty(t)||s.push(t)})),s.length&&this.trigger("warn",{message:`${t} lacks required attribute(s): ${s.join(", ")}`})}push(t){this.lineStream.push(t)}end(){this.lineStream.push("\\n"),this.trigger("end")}addParser(t){this.parseStream.addParser(t)}addTagMapper(t){this.parseStream.addTagMapper(t)}}}},e={};function i(s){var r=e[s];if(void 0!==r)return r.exports;var n=e[s]={exports:{}};return t[s].call(n.exports,n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(37)})();'}},e={};function i(s){var r=e[s];if(void 0!==r)return r.exports;var n=e[s]={exports:{}};return t[s].call(n.exports,n,n.exports,i),n.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i(114)})();